<% layout('layout', { title: title }) %>
<div class="card">
  <h2><%= auction.title %></h2>
  <p>Estado: <span class="badge"><%= auction.status %></span></p>
  <p>Precio inicial: €<%= (auction.start_price_cents/100).toFixed(2) %></p>
  <p>Tiempo restante: <span id="time-left">-</span></p>
  <p>Nº de pujas: <span id="bid-count"><%= bids.length %></span></p>
  <div id="top-bid" class="message">
    Mejor puja: <strong>€<%= (topBid/100).toFixed(2) %></strong> <% if (topBidder) { %>por <%= topBidder %><% } %>
  </div>
  <% if (auction.status === 'ended' || auction.status === 'paid') { %>
    <% if (auction.payment_link_url && isWinner) { %>
      <div class="message">¡Enhorabuena! Has ganado. </div>
      <a href="<%= auction.payment_link_url %>"><button>Pagar ahora</button></a>
    <% } else if (auction.payment_link_url) { %>
      <div class="message">La subasta ha finalizado. Ganador: <%= winner_email || 'desconocido' %>.</div>
    <% } else { %>
      <div class="message">La subasta ha finalizado.</div>
    <% } %>
  <% } else { %>
    <form id="bid-form">
      <div class="flex">
        <input id="name" placeholder="Tu nombre" required />
        <input id="email" placeholder="Tu email" type="email" required />
      </div>
      <div class="flex" style="margin-top:8px">
        <input id="amount" type="number" step="0.01" min="0.01" placeholder="Cantidad en EUR" required />
        <button type="submit">Pujar</button>
      </div>
    </form>
  <% } %>
</div>
<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  const auctionId = "<%= auction.id %>";
  const endAt = <%= Math.floor((new Date(auction.start_time).getTime() + auction.duration_seconds*1000)/1000) %>;
  function tick() {
    const left = endAt - Math.floor(Date.now()/1000);
    const el = document.getElementById('time-left');
    if (left <= 0) { el.textContent = '0s'; return; }
    el.textContent = left + 's';
    requestAnimationFrame(tick);
  }
  tick();
  socket.emit('join-auction', { auctionId });
  socket.on('bid-update', (payload) => {
    document.getElementById('bid-count').textContent = payload.bidCount;
    document.getElementById('top-bid').innerHTML = 'Mejor puja: <strong>€' + (payload.topBid/100).toFixed(2) + '</strong> por ' + (payload.topBidder || '');
  });
  socket.on('auction-ended', (payload) => {
    window.location.reload();
  });
  document.getElementById('bid-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const body = {
      name: document.getElementById('name').value,
      email: document.getElementById('email').value,
      amount_eur: parseFloat(document.getElementById('amount').value),
    };
    const r = await fetch(`/auction/${auctionId}/bid`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)});
    const j = await r.json();
    if (!r.ok) { alert(j.error || 'Error al pujar'); return; }
  });
</script>